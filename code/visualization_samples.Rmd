---
title: "Data Visualization Examples"
author: "Camila Vargas Poulsen"
date: "5/12/2021"
output: pdf_document
---




```{r setup, include=FALSE, echo=FALSE}

options(scipen=999) ##Sets R not to use scientific notations

source(here::here("R/tnc_plastic_gear_func.R"))

##load packages
library(tidyverse)
library(here)
library(janitor)
library(readxl)
library(ggtext) ##Add variable colors into text in the title of the plot
library(patchwork)
library(wesanderson)

##colors
#d6c5c5 light pink, 
#c18b8b dark pink, 
#c1d6dd light blue, 
#91a3bd" light blue dark

```




```{r, import data, include=FALSE, include=FALSE}
## Master table to match countries and gear
master_countries <- read_csv(here::here("data/tnc_plastic_gear/master_countries.csv"))

master_gear <- read_csv(here::here("data/tnc_plastic_gear/master_gear_mapping.csv"))

```



```{r data prep, include=FALSE, echo=FALSE}

## Add all names
fao_clean <- fao_clean %>% 
  rename(fao_landing_c_name = country) %>% 
  left_join(master_countries, by = "fao_landing_c_name")

watson_clean <- watson_clean %>% 
  left_join(master_countries, by = "watson_country_id")

## Calculations for plotting
## Calculating FAO total landings per year

fao_summary_year <- fao_clean %>% 
  group_by(year) %>% 
  summarise(tones = sum(landings, na.rm = T)) %>% 
  mutate(tons_2 = tones/1000000) %>% ##to make y-axis 10^6
  mutate(type = "FAO" ) %>% 
  ungroup()

## Calculating Watson totals per year (Reported, IUU and Discards) and totals by year and sector
watson_summary_year <- watson_clean %>% 
  group_by(year) %>% 
  summarise(Reported = sum(reported, na.rm = T),
            IUU = sum(iuu_total, na.rm = T),
            Discards = sum(discards, na.rm = T)) %>%
  pivot_longer(2:4, names_to = "type", values_to = "tones") %>% 
  mutate(tons_2 = tones/1000000) %>%  ##to make y-axis 10^6
  ungroup()

##We need countries to make plots by country
watson_summary_year_sector <- watson_clean %>%
  group_by(iso3_code, year, productive_sector) %>% 
  summarise(Reported = sum(reported, na.rm = T),
            IUU = sum(iuu_total, na.rm = T),
            Discards = sum(discards, na.rm = T)) %>% 
  pivot_longer(4:6, names_to = "type", values_to = "tones") %>% 
  mutate(types_all = paste0(productive_sector,"_", type)) %>% 
  mutate(tons_2 = tones/1000000) %>% 
  ungroup() %>%
  mutate(types_all = recode(types_all,
                            "non_industrial_Discards" = "Small-scale Discards", 
                            "industrial_Discards" = "Industrial Discards",
                            "non_industrial_IUU" = "Small-scale IUU",
                            "industrial_IUU" = "Industrial IUU",
                            "non_industrial_Reported" =  "Small-scale Reported",
                            "industrial_Reported" = "Industrial Reported"),
          types_all = as.factor(types_all)) %>% 
  mutate(types_all = fct_relevel(types_all, c("Small-scale Discards", "Industrial Discards", "Small-scale IUU", "Industrial IUU", "Small-scale Reported", "Industrial Reported")))

```



## Project 1: Comparing two sources of fisheries data

One of the goals of this project was to compare the total fisheries landings reported by the Food and Agriculture Organization (FAO) with global marine fisheries catch curated by Reg Watson (Watson 2017). Watson's data set identifies small-scale fisheries catch from industrial catch, and estimates illegal, unregulated and unreported catch (IUU), and discards at sea. It also includes the associated fishing gear used. On the other hand, FAO data only reports quantities on a landed weight basis.

\vspace{16pt}

```{r, echo=FALSE}  

## Watson and FAO data 2010-2015 plot
##Plot showing industrial and non-industrial differeces
fao_watson_sector_plot <- ggplot(watson_summary_year_sector %>% 
                                   filter(year %in% c(2010:2015)))+
  geom_bar(aes(x = year, y= tons_2, fill = types_all),
           stat = "identity",
           width = 0.6)+
  geom_line(data = fao_summary_year %>% 
              filter(year %in% c(2010:2015)),
            aes(x = year, y = tons_2), size = 1.5, color="#ca8603")+
  geom_point(data = fao_summary_year %>% 
               filter(year %in% c(2010:2015)),
             aes(x = year, y = tons_2), size = 2.5, color="#ca8603")+
  scale_fill_manual(values = c("#d6c5c5","#c18b8b", "#c1d6dd", "#91a3bd", "#4a4d76", "#1d2247"),
                     guide= guide_legend(title.position="top"))+
  scale_x_continuous(breaks = seq(2010,2015, 1))+
  scale_y_continuous(expand = c(0, 0), limits = c(0, 125))+  ##rmoves white space between x axis and bar
  theme_classic()+
  labs(title = paste0( "<b><span style = 'font-size: 14pt'> Comparing ",
                       "<span style = 'color:#ca8603;'>",
                       "FAO",
                       "</span></span></b>",
                       "<b><span style = 'font-size: 14pt'> and Watson's fisheries data ",
                       "</span></span></b>"))+
    theme(plot.title = ggtext::element_textbox_simple(
      size = 13,
      face = NULL,
      lineheight = 1.75,
      padding = margin(5, 5, 0, 5),
      margin = margin(0, 0, 10, 0),#top,right,bottom,left.
      fill = "white"))+
  labs(fill = "Watson's data",
       x= "Year",
       y = expression(Tones~(~10^{6})))+ ##what ever is in {} is a superscripts (for subscripts use[])
  theme(legend.position = "bottom",
        legend.text = element_text(size = 10),
        #legend.title = element_text(face = "bold"),
        legend.title.align = )


fao_watson_sector_plot

##Color codes! !!!Make one vector!
##Reported IND #1d2247
##Reported nonInd #4a4d76
##IUU IND #91a3bd
##IUU non-ind #c1d6dd
##discards IND #d6c5c5
##discards nonIND  #c18b8b
```




```{r, include=FALSE, echo=FALSE}

## Comparison by country
## Data Wrangling
fao_by_country <- fao_clean %>% 
  group_by(year,iso3_code) %>%
  summarise(tones = sum(landings, na.rm = T)) %>% 
  filter(year %in% c(2010:2015)) %>% 
  ungroup() %>% 
  arrange(desc(tones)) %>% 
  mutate(tons_2 = tones/1000000) ##to make y-axis 10^6


watson_by_country <- watson_clean %>% 
group_by(year,iso3_code) %>%
  summarise(Reported = sum(reported, na.rm = T),
            IUU = sum(iuu_total, na.rm = T),
            Discards = sum(discards, na.rm = T)) %>% 
  filter(year %in% c(2010:2015)) %>% 
  pivot_longer(3:5, names_to = "type", values_to = "tones") %>% 
  ungroup() %>% 
  mutate(tons_2 = tones/1000000) %>% ##to make y-axis 10^6
  mutate(iso3_code = as.factor(iso3_code))
```




```{r, include=FALSE, echo=FALSE}
## Identifying top countries per year.

top_10_fao <- fao_by_country %>% 
  group_by(year) %>% 
  top_n(12, tones) %>% 
  mutate(total_year_top10 = sum(tones, na.rm = T)) %>% 
  ungroup() %>% 
  select(year, iso3_code, tones_country= tones, total_year_top10) %>% 
  left_join(fao_summary_year, by = "year") %>% 
  mutate(pct_top10 = (total_year_top10/tones)*100)

##There are 13 "top countries" we will remove THA becasue it is only withing the top 12 one year.

top_10_watson <- watson_by_country %>% 
  group_by(year, iso3_code) %>% 
  summarise(total_all = sum(tones, na.rm = T)) %>% 
  top_n(12, total_all) %>% 
  arrange(desc(total_all))
##Top 12 countries in Watson NOTE 
sort(unique(top_10_watson$iso3_code)) ## Same than in FAO!
##NOTE: these are the top countries between 2010-2015
```


```{r, include=FALSE, echo=FALSE}

top_10_watson_ind <- watson_summary_year_sector %>% 
  filter(productive_sector == "industrial",
         year %in% c(2010:2015)) %>% 
  group_by(year, iso3_code) %>% 
  summarise(tons_total = sum(tones, na.rm = T)) %>% 
  top_n(10, tons_total)

sort(unique(top_10_watson_ind$iso3_code))

top_10_watson_noneInd <- watson_summary_year_sector %>% 
  filter(productive_sector != "industrial",
         year %in% c(2010:2015)) %>% 
  group_by(year, iso3_code) %>% 
  summarise(tons_total = sum(tones, na.rm = T)) %>% 
  top_n(10, tons_total)

sort(unique(top_10_watson_noneInd$iso3_code))
```



```{r, include=FALSE, echo=FALSE}
### Creating vector with top 12 countries
##Fao and Watson top 12 for 2010:2015
top4_countries <- c("CHN", "IDN", "RUS", "USA")

##Order descending according to average landed tones form 2010/2015
watson_top12_Ind <- c("CHN", "RUS", "PER", "USA", "NOR", "CHL", "IDN","JPN" , "IND", "PHL", "ISL", "ESP")

watson_top_12_Nonind <- c("CHN", "IDN", "VNM", "IND", "JPN","USA", "THA", "MEX", "MYS", "PER","KOR", "PHL")

```



```{r, echo=FALSE, fig.height=10, fig.width= 10}

##Top 4 country Plot

fao_watson_top4_plot <- ggplot(watson_by_country %>% 
                            filter(iso3_code %in% c(top4_countries)) %>% 
                              mutate(iso3_code = as.factor(iso3_code),
                                     iso3_code = fct_relevel(iso3_code, c("CHN", "IDN", "RUS", "USA"))))+
  geom_bar(aes(x = year, y= tons_2, fill = type),
           stat = "identity")+
  scale_fill_manual(values = c("#8e464e", "#335498", "#002060"))+
  geom_line(data = fao_by_country %>% 
                   filter(iso3_code %in% c(top4_countries),
                          year %in% c(2010:2015)) %>% 
                   mutate(iso3_code = as.factor(iso3_code),
                          iso3_code = fct_relevel(iso3_code, c("CHN", "IDN", "RUS", "USA"))),
            aes(x = year, y = tons_2), size = 1.2, color="#ca8603")+
  geom_point(data = fao_by_country %>% 
                    filter(iso3_code %in% c(top4_countries),
                           year %in% c(2010:2015)) %>% 
                    mutate(iso3_code = as.factor(iso3_code),
                                     iso3_code = fct_relevel(iso3_code, c("CHN", "IDN", "RUS", "USA"))),
             aes(x = year, y = tons_2), size = 1.6, color="#ca8603")+
  scale_x_continuous(breaks = seq(2010,2015, 1))+
  scale_y_continuous(expand = c(0, 0))+  ##rmoves white space between x axis and bar
  theme_classic()+
  facet_wrap(~iso3_code)+ ##scales = "free"
  labs(title = paste0( "<b><span style = 'font-size: 18pt'>Total Fisheries Capture by Country",
                       "</span></span></b>",
                       "</b><br> <span style = 'font-size:14pt'>",
                       "Top countries worldwide in fisheries captures according to ",
                       "<span style = 'color:#ca8603;'>",
                       "**FAO** ",
                       "</span></span></b>",
                       "and Watson's ",
                       "<span style = 'color:#002060;'>",
                       "**Reported,** ",
                       "</span></span></b>",
                       "<span style = 'color:#335498;'>",
                       "**IUU** ",
                       "</span></span></b>",
                       "and ",
                       "<span style = 'color:#8e464e;'>",
                       "**Discards**",
                       "</span></span></b>"))+
    theme(plot.title = ggtext::element_textbox_simple(
      size = 13,
      face = NULL,
      lineheight = 1.75,
      padding = margin(5, 5, 0, 5),
      margin = margin(0, 0, 10, 0),#top,right,bottom,left.
      fill = "white")) +
  theme(plot.title.position = "plot",
        legend.position = "none")+
        #axis.text.x = element_text(angle = 90))+
  xlab("Year")+
  ylab(expression(Tones~(~10^{6}))) ##what ever is in {} is a superscripts (for subscripts use[]))
  
fao_watson_top4_plot 

## For normal title
#   labs(fill = "Watson's data",
#        title = "Comparing FAO and Watson's fisheries data",
#        x= "Year",
#        y = expression(Tones~(~10^{6})))+ ##what ever is in {} is a superscripts (for subscripts use[])
#   theme(legend.position = "bottom")
```



```{r, include=FALSE, echo=FALSE}
## Partition by gear8 per fishing sector (Watson data)
##Data wrangling

master_gear_watson <- master_gear %>% 
  distinct(WatsonGearCode, .keep_all = TRUE)

watson_gear8 <- watson_clean %>%
  rename(WatsonGearCode = gear) %>% 
  left_join(master_gear_watson, by = "WatsonGearCode")

watson_total_gear_year_sector <- watson_gear8 %>%
    group_by(iso3_code, year, GilmanGear8Name, productive_sector) %>%
    summarise(total_reported_gear_t = sum(reported, na.rm = T),
           total_iuu_gear_t = sum(iuu_total, na.rm = T),
           total_discards_gear_t = sum(discards, na.rm = T)) %>%
  mutate(total_catch_gear_t = total_reported_gear_t + total_iuu_gear_t + total_discards_gear_t) %>% 
    ungroup() %>% 
  mutate(iso3_code = as.factor(iso3_code))

fraction_gear_year_sector <- watson_total_gear_year_sector %>%
    group_by(iso3_code , year, productive_sector) %>%
    mutate(total_reported_year_t = sum(total_reported_gear_t, na.rm = T),
           total_iuu_year_t = sum(total_iuu_gear_t, na.rm = T),
           total_discards_year_t = sum(total_discards_gear_t, na.rm = T)) %>%
    ungroup() %>%
    mutate(gear_fraction_reported = total_reported_gear_t/total_reported_year_t) %>%
    mutate(gear_fraction_full = (total_reported_gear_t + total_iuu_gear_t + total_discards_gear_t) / (total_reported_year_t + total_iuu_year_t + total_discards_year_t)) %>%
  mutate_if(is.numeric, round, 5)

watson_gear8_fraction_ind <- fraction_gear_year_sector %>% 
  filter(productive_sector == "industrial",
         iso3_code %in% c(watson_top12_Ind),
         year %in% c(2010:2015)) 

watson_gear8_fraction_Nind <- fraction_gear_year_sector %>% 
  filter(productive_sector != "industrial",
         iso3_code %in% c(watson_top_12_Nonind),
         year %in% c(2010:2015))
```



```{r, include=FALSE, echo=FALSE}

## Color Pallets
pal_antique <- rev(c("#855C75", "#D9AF6B", "#AF6458", "#736F4C", "#526A83", "#625377", "#68855C", "#9C9C5E", "#A06177", "#8C785D", "#467378", "#7C7C7C"))

```

\clearpage 

Watson's data set assigns gear types to all catches. The following figure presents proportions of catch by gear type from the 12 countries that on average reported the most small-scale fisheries catch between 2010 and 2015.


\vspace{16pt}


```{r, echo=FALSE,fig.height=10, fig.width= 10}

## Plot of non-industrial catch
partition_gear_Nind_plot <- ggplot(watson_gear8_fraction_Nind, 
                                  aes(x = iso3_code,
               y = gear_fraction_reported,
               fill = GilmanGear8Name))+
  geom_bar(stat = "identity")+
  theme_classic() +
  coord_flip()+
  facet_wrap(~year)+
  scale_fill_manual(values = pal_antique, 
                    guide= guide_legend(nrow=1, reverse = TRUE, title.position="top"))+ ##Guide tells nrows or ncol for the legend
   labs(fill = element_text("Gear Type"),
       title = "Small-scale fisheries reported catch partitioned by gear type",
       x= "Country",
       y = element_blank())+
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        plot.title = element_text(size = 16))
partition_gear_Nind_plot

```


\clearpage


## Project 2: Contributions of marine capture fisheries to the domestic livelihoods and seafood consumption of Chile

This project aimed to identify how much locally caught seafood is consumed by the Chilean population and quantify the contributions of fisheries to the local economy. To achieve this goal we looked into fisheries landings, aquaculture production, imports and export data. Here a small compilation of visualizations created for this project. See figure caption for details.

\vspace{16pt}

```{r Data_Fun_D, eval = T, echo = F, warning = F, message = F, results = 'hide'}

#### For all plots to look alike ###

ggtheme_plot <- function() {
  theme(
    plot.title = element_text(size = rel(1), hjust = 0, face = "bold"),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text       = element_text(size = 18, face = "bold"),
    panel.border     = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    axis.ticks = element_blank(),
    axis.text.x = element_text(size = 10,
                               angle = 0,
                               face = "plain"),
    axis.text.y = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.key = element_rect(colour = NA, fill = NA),
    legend.position  = "top",
    legend.justification = "center",
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.text.x = element_text(size = 20, colour = "black")
  )
}


```



```{r Top_landed_Chile_G, fig.pos="H", eval=T,  echo = FALSE, warning=FALSE, message=FALSE, fig.height=5, fig.width=9, fig.cap= 'Main species landed in Chile by the artisanal and industrial sector between 2013 and 2017. Data SERNAPESCA, 2018.' }

# Sepcies index
sp_index <- read_csv(here::here("data/oceana_chile/sp_index.csv")) %>% 
  mutate(chl_name = str_to_upper(chl_name)) 

# Importing landings and species names 
landings <- read_csv(here::here("data/oceana_chile/landings_SERNAPESCA.csv")) %>% 
  filter(region != "national") %>% 
  mutate(tons = as.numeric(tons), subsector = ifelse(subsector =='fabric_vessel', 'industrial', subsector)) %>% 
  select(-region, - month, - international_waters, chl_name = species) %>% 
  left_join(sp_index) %>% 
  select(subsector, year, tons, en_name)

landings$tons[is.na(landings$tons)] <- 0 

# Calculating annual landings per sector 
annual_landings_sector <- landings %>%
  group_by(year, subsector) %>% 
  summarise(tons = sum(tons, na.rm = T)) %>% 
  group_by(subsector) %>% 
  summarise(annual_tons = mean(tons), sd = sd(tons) )

# Top 5 landed per sector

# Artisanal
most_landed_art <- landings %>% 
  filter(subsector == 'artisanal') %>% 
  group_by(en_name) %>% 
  summarise(tons = sum(tons, na.rm= T)) %>% 
  arrange(desc(tons)) %>% 
  top_n(5, tons) 
most_landed_art <- most_landed_art$en_name

# Industrial
most_landed_ind <- landings %>% 
  filter(subsector == 'industrial') %>% 
  group_by(en_name) %>% 
  summarise(tons = sum(tons, na.rm= T)) %>% 
  arrange(desc(tons)) %>% 
  top_n(5, tons) 
most_landed_ind <- most_landed_ind$en_name

## Landings per year more landed and others

## Artisanal
landings_year_art <- landings %>%
  filter(subsector == 'artisanal') %>% 
  mutate(species = ifelse(en_name %in% most_landed_art, en_name, "Others")) 

##Industrials
landings_year<- landings %>%
  filter(subsector == 'industrial') %>% 
  mutate(species = ifelse(en_name %in% most_landed_ind, en_name, "Others")) %>% 
  rbind(landings_year_art) %>% 
  group_by(year, subsector, species) %>% 
  summarise(tons = sum(tons, na.rm= TRUE))


## Plot

landings_plot <- landings_year %>%
  ggplot(aes(x = as.numeric(year),
             y = as.numeric(tons)/1000000, 
             fill = species)) +
  geom_area() +
  facet_wrap(~subsector)+
  labs(y="Landings (Million tonnes)", x="")+
  scale_y_continuous(expand = c(0,0))+
  scale_fill_manual("Species",values = c(wes_palette("Darjeeling1"), wes_palette("Darjeeling2"),  'black'))+
  ggtheme_plot() +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE))

landings_plot

```



```{r Landings_per_region, fig.pos="H", echo = FALSE, fig.height=6, fig.width=10, warning=FALSE, message=FALSE, fig.cap= 'Mean annual total landings per region for the artisanal (left pannel) and industrial sector (right pannel) between 2013 and 2017. The color represents the most landed species in 2017 and regions are ordered from north to south. Error bars represent one standard deviation. Data Landing records from SERNAPESCA, 2018.'}

# Main species in 2017 per region and sector to add color to the barplot
# Importing landings and species names 
landings<- read_csv(here::here("data/oceana_chile/landings_SERNAPESCA.csv"))

main_species_per_region <- landings %>% 
  filter(region != "national") %>% 
  mutate(tons = as.numeric(tons), subsector = ifelse(subsector =='fabric_vessel', 'industrial', subsector)) %>% 
  arrange(year, desc(tons)) %>% 
  group_by(year, region, subsector) %>% 
  top_n(1, tons) %>% 
  filter(year == 2017)

# Landings per region 

landings_per_region <- landings %>% 
  filter(region != "national") %>% 
  mutate(tons = as.numeric(tons), subsector = ifelse(subsector =='fabric_vessel', 'industrial', subsector)) %>% 
  group_by(year, subsector, region) %>% 
  summarise(tons = sum(tons, na.rm = T))%>% 
  group_by(subsector, region) %>% 
  summarise(annual_tons = mean(tons, na.rm = T)/1000, sd = sd(tons, na.rm = T)/1000)%>% 
  left_join(main_species_per_region, by = c('region', 'subsector')) %>% 
  select(subsector, region, annual_tons, sd, chl_name = species) %>% 
  left_join(sp_index) %>% 
  select(-chl_name, -sc_name, species_2017= en_name) %>% 
  filter(species_2017 != "NA")

# Reordering regions

landings_per_region$region <- factor(landings_per_region$region , levels = c("XII", "XI", "X", "XIV", "IX", "VIII", "VII", "VI", "RM","V", "IV", "III", "II", "I", "XV", "AI"))

landings_per_region %>%
  filter(region != "AI") %>% 
  ggplot(aes(x = region,
             y = annual_tons, 
             fill=species_2017))+
  geom_bar(stat = 'identity') +
  geom_errorbar(aes(ymin=annual_tons-sd, ymax=annual_tons+sd), width=.2,
                position=position_dodge(.9)) +
  facet_wrap(~ subsector)+
  labs(y="Landings (Thousand Tons)", x="Region")+
  coord_flip()+
  scale_y_continuous(expand = c(0, 0))+
  scale_fill_manual("Species",values = c(wes_palette("Darjeeling1"), wes_palette("Darjeeling2"), wes_palette('Royal1')))+
  ggtheme_plot() +
  guides(fill = guide_legend(nrow = 4, byrow = TRUE))

```




```{r Top_Aquaculture_Chile_G, echo = FALSE, warning=FALSE, message=FALSE, fig.height=4, fig.width=7, fig.cap= 'Top 5 species farmed in Chile between 2013 and 2017. Data : Harvest records from SERNAPESCA, 2018.' }

# Importing aquaculture database
aquaculture<- read_csv(here::here("data/oceana_chile/aquaculture_SERNAPESCA.csv")) %>% 
  filter(month == "anual") %>% 
  mutate(tons = as.numeric(tons), chl_name = species) %>%
  left_join(sp_index) %>% 
  select(year, region, tons, en_name)

# Overall, top 5 

most_farmed <- aquaculture %>% 
  group_by(en_name) %>% 
  summarise(tons = sum(tons, na.rm= T)) %>% 
  arrange(desc(tons)) %>% 
  top_n(5, tons) 

most_farmed <- most_farmed$en_name

# Top aquaculture
aquaculture %>% 
  mutate(species = ifelse(en_name %in% most_farmed, en_name, 'Others')) %>% 
  group_by(year, species) %>% 
  summarise(tons = sum(tons, na.rm = T))%>% 
  ggplot(aes(x = year, y = tons/1000000, fill = species))+
  geom_area() +
  labs(y="Harvest (Million Tonnes)", x="Year")+
  scale_y_continuous(expand = c(0, 0))+
  scale_fill_manual("Species",values = c(wes_palette("Darjeeling1"), wes_palette("Darjeeling2"))) +
  ggtheme_plot() +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))

```




```{r Trade_Chile, echo = FALSE, warning=FALSE, message=FALSE, fig.height=4, fig.width=8, fig.cap="Main species exported and imported in Chile between 2013 and 2017. Note that the scales differ."}

# Importing export and import data 
sp_exports<- read_csv(here::here("data/oceana_chile/exports_ADUANA.csv"))
sp_imports<- read_csv(here::here("data/oceana_chile/imports_ADUANA.csv"))

# Matching database
exports_index <- read.csv(here::here("data/oceana_chile/exports_index.csv"))
imports_index <- read_csv(here::here("data/oceana_chile/imports_index.csv"))

#### New plot 

# Determine Top 10 Exported species between 2013 and 2017 (sum imports)
Top_Exports <- sp_exports%>% 
  filter(year != 2018) %>% 
  mutate(export_name= grupo_exportacion)%>% 
  left_join(exports_index) %>% 
  group_by(trade_name) %>% 
  summarise(Tons = sum(tons)) %>% #tons
  filter(!is.na(trade_name)) %>% 
  mutate(trade_name = as.character(trade_name)) %>% 
  arrange(desc(Tons)) %>% 
  top_n(5, Tons) 

Five_Exports <- sp_exports%>% 
  filter(year != 2018) %>% 
  mutate(export_name= grupo_exportacion)%>% 
  left_join(exports_index) %>% 
  filter(!is.na(trade_name)) %>%
  mutate(trade_name = as.character(trade_name)) %>% 
  mutate(species = ifelse(trade_name %in% Top_Exports$trade_name, trade_name, "Others")) %>% 
  group_by(species, year) %>% 
  summarise(Tons = round(sum(tons, na.rm=T),1)) %>% #tons
  ungroup()  %>% 
  mutate(Operation = "Exports")


# Determine Top 10 Imported species between 2013 and 2017 (sum imports)
Top_Imports <- sp_imports%>% 
  filter(year != 2018) %>% 
  mutate(imports_name= name_sp)%>% 
  left_join(imports_index) %>% 
  group_by(trade_name) %>% 
  summarise(Tons = sum(tons)) %>% #tons
  filter(!is.na(trade_name)) %>% 
  mutate(trade_name = as.character(trade_name)) %>% 
  arrange(desc(Tons)) %>% 
  top_n(5, Tons) 

Five_Imports <- sp_imports%>% 
  filter(year != 2018) %>% 
  mutate(imports_name= name_sp)%>% 
  left_join(imports_index) %>% 
  filter(!is.na(trade_name)) %>%
  mutate(trade_name = as.character(trade_name)) %>% 
  mutate(species = ifelse(trade_name %in% Top_Imports$trade_name, trade_name, "Others")) %>% 
  group_by(species, year) %>% 
  summarise(Tons = round(sum(tons, na.rm=T),1)) %>% #tons
  ungroup() %>% 
  mutate(Operation = "Imports")

# Final plot
Five_Exports %>% 
  bind_rows(Five_Imports) %>% 
  ggplot(.,
         aes(
           x = as.numeric(year),
           y = Tons/1000000,
           fill = species
         )
  ) +
  geom_area()+
  facet_wrap(~ Operation,
             scales = 'free',
             nrow = 1#,
             # strip.position =  "right"
  ) +
  ggtheme_plot() +
  scale_fill_manual("Operation", values = c(wes_palette("Darjeeling1"), wes_palette("Darjeeling2"),  'black')) +
  ggtheme_plot() +
  xlab("") +
  ylab("Tonnes (Million)")


```






